{% macro create_validation_form(form) %}
    {% from "formhelpers.html" import render_field %}

    <form id="validation_form" method="POST" enctype="multipart/form-data">
        {{ form.csrf_token }}
        {{ render_field(form.spreadsheet) }}
        <div id="additional_options">
                <div id="worksheet_option">
                {{ render_field(form.worksheet) }}
                </div>
                <table id="spreadsheet_headers_table"></table>
                {{ render_field(form.tag_columns) }}
                {{ render_field(form.has_headers) }}
                {{ render_field(form.generate_warnings) }}
                <button id="validate" type="button">Validate</button>
        </div>
    </form>

    <script>
        const EXCEL_FILE_EXTENSIONS = ['xlsx', 'xls'];
        const TEXT_FILE_EXTENSIONS = ['tsv', 'csv', 'txt'];
        $(document).ready(function () {
            hideAdditionalOptions();
        });

        /**
         * Checks if the file uploaded has a valid spreadsheet extension. Additional options will be shown if it does.
         */
        $('#spreadsheet').change(function () {
            var spreadsheet = $('#spreadsheet');
            var spreadsheetPath = spreadsheet.val();
            var spreadsheetFile = spreadsheet[0].files[0];
            if (cancelWasPressedInChromeFileUpload(spreadsheetPath)) {
                resetAndHideForm();
            }
            else if (fileHasValidExtension(spreadsheetPath, EXCEL_FILE_EXTENSIONS)) {
                getWorksheetsInfo(spreadsheetFile);
                showAdditionalOptions();
            }
            else if (fileHasValidExtension(spreadsheetPath, TEXT_FILE_EXTENSIONS)) {
                getSpreadsheetHeadersInfo(spreadsheetFile);
                showAdditionalOptions(false);
            }else {
                resetAndHideForm();
                flashInvalidExcelExtensionMessage();

            }
        });

        /**
         * Flash message when Excel workbook file extension is invalid.
         */
        function flashInvalidExcelExtensionMessage() {
            flashMessageOnScreen('Please upload an Excel or Text spreadsheet (.xlsx, .xls, .tsv, .csv, .txt)', 'error');
        }

        /**
         * Gets the information associated with the Excel worksheet that was newly selected. This information contains
         * the names of the headers and column indices that contain HED tags.
         */
        $('#worksheet').change(function () {
            var spreadsheetFile = $('#spreadsheet')[0].files[0];
            var worksheetName = $('#worksheet option:selected').text();
            getSpreadsheetHeadersInfo(spreadsheetFile, worksheetName);
        });

        /**
         * Flash a message on the screen.
         * @param {String} message - The message that will be flashed on the screen.
         * @param {String} category - The category of the message. The categories are 'error', 'success', and 'other'.
         */
        function flashMessageOnScreen(message, category) {
            var flashMessage = document.getElementById("flash_message")
            flashMessage.innerHTML = message;
            setFlashMessageCategory(flashMessage, category);
        }

        /**
         * Flash a message on the screen.
         * @param {Object} flashMessage - The li element containing the flash message.
         * @param {String} category - The category of the message. The categories are 'error', 'success', and 'other'.
         */
        function setFlashMessageCategory(flashMessage, category) {
            if ("error" == category) {
                flashMessage.style.backgroundColor = 'lightcoral';
            } else if ("success" == category) {
                flashMessage.style.backgroundColor = 'palegreen';
            } else {
                flashMessage.style.backgroundColor = '#f0f0f5';
            }
        }

        /**
         * Checks to see if the user pressed cancel in chrome's file upload browser.
         * @param {String} filePath - A path to a file.
         * @returns {boolean} - True if the user selects cancel in chrome's file upload browser.
         */
        function cancelWasPressedInChromeFileUpload(filePath) {
            return isEmptyStr(filePath) && (window.chrome)
        }

        /**
         * Resets the fields in the form and hides the additional options.
         */
        function resetAndHideForm() {
            $('#validation_form')[0].reset();
            hideAdditionalOptions();
        }

        /**
         * Flash a submit message.
         * @param {Array} worksheetNames - An array containing the names of Excel workbook worksheets.
         */
        function flashSubmitMessages() {
            flashMessageOnScreen('Worksheet is being validated ...', 'success')
        }

        /**
         * Submits the form if the tag columns textbox is valid.
         */
        $('#validate').click(function () {
            if (tagColumnsTextboxIsValid()) {
                submitForm();
            }
        });

        /**
         * Submit the form and return the validation results. If there are issues then they are returned in an attachment
         * file.
         */
        function submitForm() {
            var validationForm = document.getElementById("validation_form");
            var formData = new FormData(validationForm);
            flashSubmitMessages();
            $.ajax({
                    type: 'POST',
                    url: "{{url_for('validate_spreadsheet_from_form')}}",
                    data: formData,
                    contentType: false,
                    processData: false,
                    dataType: 'json',
                    success: function (validationStatus) {
                        if (checkRowIssueCount(validationStatus['row_issue_count'])) {
                            document.location = '/download/' + validationStatus['download_file'];
                        }
                        else {
                            document.location = '/delete/' + validationStatus['download_file'];
                        }
                        resetAndHideForm();
                    },
                    error: function () {
                        flashMessageOnScreen('Spreadsheet could not be processed.', 'error');
                        resetAndHideForm();
                    }
                }
            )
            ;
        }

        /**
         * Check the number of row issues and flash it.
         * @param {Number} rowIssueCount - Number of row issues.
         * @returns {boolean} - True if there issues found. Number of row issues are greater than 0.
         */
        function checkRowIssueCount(rowIssueCount) {
            var issuesFound = false;
            if (rowIssueCount == 0) {
                flashMessageOnScreen('No issues were found. Thank you!', 'success');
            } else {
                flashMessageOnScreen(rowIssueCount.toString() + ' rows have issues. Creating attachment ...', 'error');
                issuesFound = true;
            }
            return issuesFound;
        }

        /**
         * Checks to see if the tag columns textbox has valid input. Valid input is an integer or a comma-separated list of
         * integers that are the column indices in a Excel worksheet that contain HED tags.
         * @returns {boolean} - True if the tags columns textbox is valid.
         */
        function tagColumnsTextboxIsValid() {
            var pattern = new RegExp('^([ \\d]+,)*[ \\d]+$');
            var valid = pattern.test($('#tag_columns').val());
            if (!valid) {
                flashMessageOnScreen('Tag column(s) must be a number or a comma-separated list of numbers', 'error')
            }
            return valid;
        }

        /**
         * Checks to see if a string is empty. Empty meaning null or a length of zero.
         * @param {String} str - A string.
         * @returns {boolean} - True if the string is null or its length is 0.
         */
        function isEmptyStr(str) {
            if (str == null || str.length == 0) {
                return true;
            }
            return false;
        }

        /**
         * Compares the file extension of the file at the specified path to an Array of accepted file extensions.
         * @param {String} filePath - A path to a file.
         * @param {Array} acceptedFileExtensions - An array of accepted file extensions.
         * @returns {boolean} - True if the file has an accepted file extension.
         */
        function fileHasValidExtension(filePath, acceptedFileExtensions) {
            var fileExtension = filePath.split('.').pop();
            if ($.inArray(fileExtension.toLowerCase(), acceptedFileExtensions) != -1) {
                return true;
            }
            return false;
        }

        /**
         * Gets information associated with the Excel workbook worksheets. This information contains the names of the
         * worksheets, the names of the headers in the first worksheet, and column indices that contain HED tags in the
         * first worksheet.
         * @param {Object} workbookFile - An Excel workbook file.
         */
        function getWorksheetsInfo(workbookFile) {
            var formData = new FormData();
            formData.append('spreadsheet_file', workbookFile);
            $.ajax({
                type: 'POST',
                url: "{{url_for('get_worksheets_info')}}",
                data: formData,
                contentType: false,
                processData: false,
                dataType: 'json',
                success: function (worksheetsInfo) {
                    setComponentsRelatedToWorksheets(worksheetsInfo);
                    flashWorksheetNumberMessage(worksheetsInfo['worksheet_names']);
                },
                error: function () {
                    flashMessageOnScreen('Spreadsheet could not be processed.', 'error');
                }
            });
        }

        /**
         * Flash a message showing the number of worksheets in an Excel workbook.
         * @param {Array} worksheetNames - An array containing the names of Excel workbook worksheets.
         */
        function flashWorksheetNumberMessage(worksheetNames) {
            var numberOfWorksheets = worksheetNames.length.toString();
            flashMessageOnScreen(numberOfWorksheets + ' worksheet(s) found', 'success');
        }

        /**
         * Gets the spreadsheet headers.
         * @param {Object} spreadsheetFile - A spreadsheet file.
         * @param {String} worksheetName - An Excel worksheet name.
         */
        function getSpreadsheetHeadersInfo(spreadsheetFile, worksheetName) {
            var formData = new FormData();
            formData.append('spreadsheet_file', spreadsheetFile);
            if (typeof worksheetName !== 'undefined') {
                formData.append('worksheet_name', worksheetName);
            }
            $.ajax({
                type: 'POST',
                url: "{{url_for('get_spreadsheet_headers_info')}}",
                data: formData,
                contentType: false,
                processData: false,
                dataType: 'json',
                success: function (spreadsheetHeadersInfo) {
                    setComponentsRelatedToSpreadsheetHeaders(spreadsheetHeadersInfo);
                    flashSpreadsheetHeaderMessage(spreadsheetHeadersInfo['spreadsheet_tag_columns_indices']);
                },
                error: function () {
                    flashMessageOnScreen('Spreadsheet could not be processed.', 'error');
                }
            });
        }

        /**
         * Flash a message showing the number of column headers that contain tags.
         * @param {Array} spreadsheetTagColumnIndices - An array containing the indices of the column headers that
         * contain tags.
         */
        function flashSpreadsheetHeaderMessage(spreadsheetTagColumnIndices) {
            var numberOfTagColumns = spreadsheetTagColumnIndices.length.toString();
            if (numberOfTagColumns == '0') {
                flashMessageOnScreen('No tag columns found... Using the 2nd column', 'error');
            } else {
                flashMessageOnScreen(numberOfTagColumns + ' tag column(s) found', 'success');
            }
        }

        /**
         * Sets components related to an Excel worksheet.
         * @param {JSON} worksheetsInfo - A JSON object containing information related to the Excel worksheet. This
         * information contains the names of the worksheets in a workbook, the names of the headers in the first worksheet,
         * and column indices that contain HED tags in the first worksheet.
         */
        function setComponentsRelatedToWorksheets(worksheetsInfo) {
            populateWorksheetSelectbox(worksheetsInfo['worksheet_names']);
            setComponentsRelatedToSpreadsheetHeaders(worksheetsInfo);
        }

        /**
         * Shows additional options in the form.
         * @param {JSON} showWorksheets - If false, don't show worksheets in form.
         */
        function showAdditionalOptions(showWorksheets){
            $('#additional_options').show();
            if (typeof showWorksheets !== 'undefined' && !showWorksheets) {
                $('#worksheet_option').hide();
            }
        }

        /**
         * Hides additional options in the form.
         */
        function hideAdditionalOptions(){
            $('#additional_options').hide();
        }

        /**
         * Sets the components related to the Excel worksheet headers.
         * @param {JSON} spreadsheetHeadersInfo - A JSON object containing information related to the spreadsheet
         * headers.
         * This information contains the names of the headers and column indices that contain HED tags.
         */
        function setComponentsRelatedToSpreadsheetHeaders(spreadsheetHeadersInfo) {
            if (spreadsheetHeadersAreEmpty(spreadsheetHeadersInfo['spreadsheet_headers'])) {
                setComponentsRelatedToEmptySpreadsheetHeaders();
            } else {
                setComponentsRelatedToNonEmptySpreadsheetHeaders(spreadsheetHeadersInfo['spreadsheet_headers']);
            }
            if (spreadsheetTagColumnsIndicesAreEmpty(spreadsheetHeadersInfo['spreadsheet_tag_columns_indices'])){
                setComponentsRelatedToEmptySpreadsheetTagColumnIndices();
            } else {
                populateTagColumnsTextbox(spreadsheetHeadersInfo['spreadsheet_tag_columns_indices']);
            }
        }

        /**
         * Sets the components related to the spreadsheet headers when they are not empty.
         * @param {Array} spreadsheetHeaders - An array containing the spreadsheet headers.
         * @param {Array} spreadsheetTagColumnIndices - An integer array of tag column indices found in the spreadsheet
         * headers.
         */
        function setComponentsRelatedToNonEmptySpreadsheetHeaders(spreadsheetHeaders) {
            populateSpreadsheetHeadersTable(spreadsheetHeaders);
            $('#has_headers').prop('checked', true);
            $('#spreadsheet_headers_table').show();
        }


        /**
         * Sets the components related to the spreadsheet tag column indices when they are empty.
         */
        function setComponentsRelatedToEmptySpreadsheetTagColumnIndices() {
            $('#tag_columns').val('2');
        }

        /**
         * Sets the components related to Excel worksheet headers when they are all empty.
         */
        function setComponentsRelatedToEmptySpreadsheetHeaders() {
            $('#has_headers').prop('checked', false);
            $('#spreadsheet_headers_table').hide();
        }

        /**
         * Populate the Excel worksheet select box.
         * @param {Array} worksheetNames - An array containing the Excel worksheet names.
         */
        function populateWorksheetSelectbox(worksheetNames) {
            var worksheetSelectbox = $('#worksheet');
            var numberOfWorksheetNames = worksheetNames.length;
            worksheetSelectbox.empty();
            for (var i = 0; i < numberOfWorksheetNames; i++) {
                worksheetSelectbox.append(new Option(worksheetNames[i], worksheetNames[i]));
            }
        }

        /**
         * Populate the tag column textbox from the tag column indices found in the spreadsheet headers.
         * @param {Array} spreadsheetTagColumnIndices - An integer array of tag column indices found in the spreadsheet
         * headers.
         */
        function populateTagColumnsTextbox(spreadsheetTagColumnIndices) {
            $('#tag_columns').val(spreadsheetTagColumnIndices.sort().map(String));
        }

        /**
         * Checks to see if the spreadsheet headers are empty.
         * @param {Array} spreadsheetHeaders - An array containing the spreadsheet headers.
         * @returns {boolean} - True if the spreadsheet headers are all empty.
         */
        function spreadsheetHeadersAreEmpty(spreadsheetHeaders) {
            var numberOfSpreadsheetHeaders = spreadsheetHeaders.length;
            for (var i = 0; i < numberOfSpreadsheetHeaders; i++) {
                if (!isEmptyStr(spreadsheetHeaders[i].trim())) {
                    return false;
                }
            }
            return true;
        }

                /**
         * Checks to see if the spreadsheet tag column indices are empty.
         * @param {Array} spreadsheetTagColumnsIndices - An array containing the tag column indices based on the
         *                headers found in the spreadsheet.
         * @returns {boolean} - True if the spreadsheet tag column indices array is empty.
         */
        function spreadsheetTagColumnsIndicesAreEmpty(spreadsheetTagColumnsIndices) {
            var numberOfTagColumnIndices = spreadsheetTagColumnsIndices.length;
            if (numberOfTagColumnIndices > 0) {
                return false;
            }
            return true;
        }

        /**
         * Populates a table containing the spreadsheet headers.
         * @param {Array} spreadsheetHeaders - An array containing the spreadsheet headers.
         */
        function populateSpreadsheetHeadersTable(spreadsheetHeaders) {
            var spreadsheetHeadersTable = $('#spreadsheet_headers_table');
            var spreadsheetHeadersRow = $('<tr/>');
            var numberOfSpreadsheetHeaders = spreadsheetHeaders.length;
            spreadsheetHeadersTable.empty();
            for (var i = 0; i < numberOfSpreadsheetHeaders; i++) {
                spreadsheetHeadersRow.append('<td>' + spreadsheetHeaders[i] + '</td>');
            }
            spreadsheetHeadersTable.append(spreadsheetHeadersRow);
        }

    </script>
{% endmacro %}